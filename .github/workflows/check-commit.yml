# .github/workflows/check-commit.yml
name: Check Commit Message
on:
  workflow_call:
    outputs:
      allowed:
        description: "Whether the commit message matches allowed patterns"
        value: ${{ jobs.check.outputs.allowed }}

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      allowed: ${{ steps.check-msg.outputs.allowed }}

    steps:
      - name: Checkout repo (required to read commit message)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read HEAD commit message and decide
        id: check-msg
        run: |
          # Read most recent commit message (works for push with many commits)
          MSG=$(git --no-pager log -1 --pretty=%B | tr -d '\r')
          echo "Commit message (HEAD):"
          echo "$MSG"
          echo "---"
          
          # Check for allowed prefixes: feat:, fix:, feat!:
          if [[ "$MSG" =~ ^feat: ]] || [[ "$MSG" =~ ^fix: ]] || [[ "$MSG" =~ ^feat!: ]]; then
            echo "✓ Commit message matches allowed pattern"
            echo "allowed=true" >> $GITHUB_OUTPUT
            echo "Set allowed=true"
          else
            echo "✗ Commit message does NOT match allowed patterns (feat:, fix:, feat!:)"
            echo "allowed=false" >> $GITHUB_OUTPUT
            echo "Set allowed=false"
          fi
          
      - name: Debug output value
        run: |
          echo "Output 'allowed' was set to: ${{ steps.check-msg.outputs.allowed }}"
